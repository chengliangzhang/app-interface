<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="GetPermissionByUserAndRoleMapper" >

  <!-- 查询在roleId中的权限（但是没有在roleIds中的权限） -->
  <select id="getPermissionByUserAndRole" resultType="java.lang.String" parameterType="java.util.Map">
    SELECT DISTINCT a.permission_id
    from maoding_web_user_permission a
    LEFT JOIN maoding_web_role_permission b on a.permission_id = b.permission_id
    where a.user_id = #{userId}
    and b.role_id = #{roleId}
    and b.company_id = #{companyId}
    <if test="roleIds != null">
      and a.permission_id NOT IN (
        SELECT DISTINCT a.permission_id
        from maoding_web_user_permission a
        LEFT JOIN maoding_web_role_permission b on a.permission_id = b.permission_id
        where a.user_id = #{userId}
        and b.company_id = #{companyId}
        and b.role_id  in
        <foreach collection="roleIds" index="i" item="role" open="(" separator="," close=")">
          #{role}
        </foreach>
      )
    </if>

  </select>

</mapper>